#!/usr/bin/env bash
set -eu

# extract-design-tokens.sh â€” Extracts design tokens from a project's CSS/Tailwind config
# Outputs font families, color palette, spacing, and dark mode values for use in
# standalone HTML mockups that match the project's real look and feel.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
  cat <<'EOF'
Usage: extract-design-tokens.sh [PROJECT_DIR] [OPTIONS]

Extracts design tokens (fonts, colors, spacing) from a frontend project's
CSS files and Tailwind config for use in standalone HTML mockups.

Arguments:
  PROJECT_DIR    Path to the frontend project root (default: current directory)

Options:
  --format html  Output as an HTML <style> block (default)
  --format json  Output as JSON
  --format css   Output as raw CSS variables
  -h, --help     Show this help message

Examples:
  extract-design-tokens.sh ./frontend
  extract-design-tokens.sh ./frontend --format json
  extract-design-tokens.sh ./frontend --format html > mockup-tokens.html
EOF
  exit 0
}

FORMAT="html"
PROJECT_DIR="."

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    --format)
      FORMAT="$2"
      shift 2
      ;;
    *)
      PROJECT_DIR="$1"
      shift
      ;;
  esac
done

if [[ ! -d "$PROJECT_DIR" ]]; then
  echo "Error: Directory '$PROJECT_DIR' does not exist" >&2
  exit 1
fi

# --- Extract Google Fonts from index.html ---
GOOGLE_FONTS_URL=""
GOOGLE_FONTS_LINK=""
for html_file in "$PROJECT_DIR/index.html" "$PROJECT_DIR/public/index.html" "$PROJECT_DIR/src/index.html"; do
  if [[ -f "$html_file" ]]; then
    GOOGLE_FONTS_URL=$(grep -oE 'https://fonts\.googleapis\.com/css2[^"'"'"']+' "$html_file" 2>/dev/null | head -1 || true)
    if [[ -n "$GOOGLE_FONTS_URL" ]]; then
      GOOGLE_FONTS_LINK="<link href=\"$GOOGLE_FONTS_URL\" rel=\"stylesheet\">"
      break
    fi
  fi
done

# --- Extract CSS custom properties from main CSS file ---
CSS_VARS=""
for css_file in "$PROJECT_DIR/src/index.css" "$PROJECT_DIR/src/styles/globals.css" "$PROJECT_DIR/src/app/globals.css" "$PROJECT_DIR/src/main.css" "$PROJECT_DIR/src/styles.css"; do
  if [[ -f "$css_file" ]]; then
    # Extract :root block variables
    CSS_VARS=$(sed -n '/:root/,/}/p' "$css_file" 2>/dev/null | grep -E '^\s*--' || true)
    # Also extract dark mode variables
    DARK_VARS=$(sed -n '/\.dark/,/}/p' "$css_file" 2>/dev/null | grep -E '^\s*--' || true)
    if [[ -z "$DARK_VARS" ]]; then
      DARK_VARS=$(sed -n '/@media.*prefers-color-scheme.*dark/,/}/p' "$css_file" 2>/dev/null | grep -E '^\s*--' || true)
    fi
    CSS_FILE_FOUND="$css_file"
    break
  fi
done

# --- Extract font families from Tailwind config ---
TAILWIND_FONTS=""
for tw_config in "$PROJECT_DIR/tailwind.config.js" "$PROJECT_DIR/tailwind.config.ts" "$PROJECT_DIR/tailwind.config.mjs"; do
  if [[ -f "$tw_config" ]]; then
    TAILWIND_FONTS=$(grep -A 3 'fontFamily' "$tw_config" 2>/dev/null | grep -oE "'[^']+'" | tr -d "'" || true)
    TAILWIND_CONFIG_FOUND="$tw_config"
    break
  fi
done

# --- Extract Tailwind custom colors ---
TAILWIND_COLORS=""
for tw_config in "$PROJECT_DIR/tailwind.config.js" "$PROJECT_DIR/tailwind.config.ts" "$PROJECT_DIR/tailwind.config.mjs"; do
  if [[ -f "$tw_config" ]]; then
    TAILWIND_COLORS=$(grep -A 50 'colors' "$tw_config" 2>/dev/null | grep -E "^\s+'?[a-zA-Z]" | head -20 || true)
    break
  fi
done

# --- Output ---
case "$FORMAT" in
  html)
    echo "<!-- Design tokens extracted from: $PROJECT_DIR -->"
    echo "<!-- Generated by extract-design-tokens.sh -->"
    echo ""
    if [[ -n "$GOOGLE_FONTS_LINK" ]]; then
      echo "<!-- Google Fonts -->"
      echo "<link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">"
      echo "<link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>"
      echo "$GOOGLE_FONTS_LINK"
      echo ""
    fi
    echo "<style>"
    echo "  :root {"
    if [[ -n "$CSS_VARS" ]]; then
      echo "$CSS_VARS"
    else
      echo "    /* No CSS custom properties found in project */"
    fi
    echo "  }"
    if [[ -n "$DARK_VARS" ]]; then
      echo ""
      echo "  .dark {"
      echo "$DARK_VARS"
      echo "  }"
    fi
    echo "</style>"
    echo ""
    echo "<!-- Source files: -->"
    [[ -n "${CSS_FILE_FOUND:-}" ]] && echo "<!-- CSS: $CSS_FILE_FOUND -->"
    [[ -n "${TAILWIND_CONFIG_FOUND:-}" ]] && echo "<!-- Tailwind: $TAILWIND_CONFIG_FOUND -->"
    if [[ -n "$TAILWIND_FONTS" ]]; then
      echo "<!-- Tailwind fonts: $TAILWIND_FONTS -->"
    fi
    ;;

  json)
    echo "{"
    echo "  \"source\": \"$PROJECT_DIR\","
    echo "  \"googleFontsUrl\": \"${GOOGLE_FONTS_URL:-null}\","
    echo "  \"cssFile\": \"${CSS_FILE_FOUND:-null}\","
    echo "  \"tailwindConfig\": \"${TAILWIND_CONFIG_FOUND:-null}\","
    echo "  \"cssVariables\": $(echo "${CSS_VARS:-}" | sed 's/^\s*//' | jq -Rs . 2>/dev/null || echo '""'),"
    echo "  \"darkModeVariables\": $(echo "${DARK_VARS:-}" | sed 's/^\s*//' | jq -Rs . 2>/dev/null || echo '""'),"
    echo "  \"tailwindFonts\": $(echo "${TAILWIND_FONTS:-}" | jq -Rs . 2>/dev/null || echo '""')"
    echo "}"
    ;;

  css)
    echo "/* Design tokens from: $PROJECT_DIR */"
    echo ":root {"
    if [[ -n "$CSS_VARS" ]]; then
      echo "$CSS_VARS"
    fi
    echo "}"
    if [[ -n "$DARK_VARS" ]]; then
      echo ""
      echo ".dark {"
      echo "$DARK_VARS"
      echo "}"
    fi
    ;;

  *)
    echo "Error: Unknown format '$FORMAT'. Use html, json, or css." >&2
    exit 2
    ;;
esac
